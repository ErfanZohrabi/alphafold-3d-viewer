<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enhanced AlphaFold & PDB 3D Protein Viewer</title>
  <style>
    :root { 
      color-scheme: light dark;
      --primary-color: #2563eb;
      --secondary-color: #059669;
      --accent-color: #dc2626;
      --bg-color: #ffffff;
      --surface-color: #f8fafc;
      --border-color: #e2e8f0;
      --text-color: #1e293b;
      --text-muted: #64748b;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #0f172a;
        --surface-color: #1e293b;
        --border-color: #334155;
        --text-color: #f1f5f9;
        --text-muted: #94a3b8;
      }
    }
    
    * { box-sizing: border-box; }
    
    body { 
      margin: 0; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    header { 
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1rem 1.5rem;
      box-shadow: var(--shadow-lg);
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    h1 { 
      font-size: 1.5rem; 
      margin: 0; 
      font-weight: 700;
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 1.5rem;
      min-height: calc(100vh - 100px);
    }
    
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .card {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }
    
    .card h3 {
      margin: 0 0 1rem 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-color);
    }
    
    .search-section {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }
    
    .search-form {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    input[type="text"] {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-size: 1rem;
      background: var(--bg-color);
      color: var(--text-color);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--border-color);
      color: var(--text-color);
    }
    
    .btn-secondary:hover {
      background: #cbd5e1;
    }
    
    .btn-success {
      background: var(--secondary-color);
      color: white;
    }
    
    .btn-success:hover {
      background: #047857;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
      padding: 0.4rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }
    
    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
    }
    
    .button-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .control-select {
      appearance: none;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.3s ease;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
    }
    
    .control-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .examples {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .example-btn {
      padding: 0.375rem 0.75rem;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .example-btn:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    #viewer {
      width: 100%;
      height: 600px;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid var(--border-color);
      background: var(--surface-color);
      cursor: grab;
      user-select: none;
      touch-action: none;
      position: relative;
    }
    
    #viewer:active {
      cursor: grabbing;
    }
    
    #viewer canvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
      touch-action: none;
    }
    
    .status {
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
      font-weight: 500;
    }
    
    .status.info {
      background: rgb(59 130 246 / 0.1);
      color: var(--primary-color);
      border: 1px solid rgb(59 130 246 / 0.2);
    }
    
    .status.success {
      background: rgb(5 150 105 / 0.1);
      color: var(--secondary-color);
      border: 1px solid rgb(5 150 105 / 0.2);
    }
    
    .status.error {
      background: rgb(220 38 38 / 0.1);
      color: var(--accent-color);
      border: 1px solid rgb(220 38 38 / 0.2);
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .control-group label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.25rem;
      display: block;
    }
    
    select {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 0.875rem;
      width: 100%;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5rem 1.5rem;
      padding-right: 2.5rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
    }
    
    select option {
      background: var(--bg-color);
      color: var(--text-color);
      padding: 0.5rem;
    }
    
    .metadata-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .metadata-item:last-child {
      border-bottom: none;
    }
    
    .metadata-label {
      font-weight: 500;
      color: var(--text-muted);
    }
    
    .metadata-value {
      color: var(--text-color);
      text-align: right;
      max-width: 60%;
      word-wrap: break-word;
    }
    
    .source-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .tab {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      background: var(--bg-color);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    
    .tab.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .export-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    .loading-large {
      width: 2rem;
      height: 2rem;
      border-width: 3px;
    }
    
    .pulse {
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        padding: 1rem;
      }
      
      .search-form {
        flex-direction: column;
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .header-content {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }
      
      #viewer {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>🧬 Enhanced AlphaFold & PDB 3D Viewer</h1>
      <div style="display: flex; gap: 0.5rem;">
        <span class="badge">Mol*</span>
        <span class="badge">AlphaFold</span>
        <span class="badge">PDB</span>
        <span class="badge">Flask</span>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="main-content">
      <div class="search-section">
        <h2 style="margin-top: 0;">🔍 Search Protein Structures</h2>
        <p style="color: var(--text-muted); margin-bottom: 1rem;">
          Search by UniProt ID (e.g., <code>P05067</code>), PDB ID (e.g., <code>1A2B</code>), or protein name (e.g., "insulin").
        </p>
        
        <div class="search-form">
          <input id="searchInput" type="text" placeholder="Enter protein name, UniProt ID, or PDB ID..." />
          <button id="searchBtn" class="btn btn-primary">
            <span id="searchIcon">🔍</span> Search
          </button>
          <button id="resetBtn" class="btn btn-secondary">Reset</button>
        </div>
        
        <div class="examples">
          <strong style="color: var(--text-muted); margin-right: 0.5rem;">Examples:</strong>
          <button class="example-btn" data-example="P05067">P05067 (Amyloid-β)</button>
          <button class="example-btn" data-example="TP53">TP53 (Tumor Protein)</button>
          <button class="example-btn" data-example="insulin">Insulin</button>
          <button class="example-btn" data-example="1A2B">1A2B (PDB)</button>
          <button class="example-btn" data-example="hemoglobin">Hemoglobin</button>
          <button class="example-btn" data-example="2HHB">2HHB (PDB)</button>
          <button class="example-btn" data-example="lysozyme">Lysozyme</button>
          <button class="example-btn" data-example="collagen">Collagen</button>
        </div>
      </div>

      <div id="statusContainer" style="display: none;">
        <div id="status" class="status"></div>
      </div>

      <div id="sourceSelection" style="display: none;" class="card">
        <h3>📊 Available Structure Sources</h3>
        <div id="sourceTabs" class="source-tabs"></div>
        <div id="sourceDescription" style="color: var(--text-muted); font-size: 0.875rem;"></div>
      </div>

      <div id="viewer"></div>
    </div>

    <div class="sidebar">
      <div class="card">
        <h3>🎛️ Visualization Controls</h3>
        <div class="controls-grid">
          <div class="control-group">
            <label for="representation">🎨 Representation</label>
            <select id="representation" class="control-select">
              <option value="cartoon">Cartoon (Default)</option>
              <option value="cartoon-putty">Cartoon + Confidence</option>
              <option value="surface">Surface</option>
              <option value="ball-and-stick">Ball & Stick</option>
              <option value="spacefill">Space Fill</option>
              <option value="ribbon">Ribbon</option>
              <option value="backbone">Backbone Only</option>
            </select>
          </div>
          <div class="control-group">
            <label for="coloring">🌈 Color Scheme</label>
            <select id="coloring" class="control-select">
              <option value="chain">By Chain</option>
              <option value="confidence">By Confidence</option>
              <option value="secondary">Secondary Structure</option>
              <option value="element">By Element</option>
              <option value="residue">By Residue</option>
              <option value="hydrophobicity">By Hydrophobicity</option>
              <option value="charge">By Charge</option>
            </select>
          </div>
          <div class="control-group">
            <label>⚡ Quick Actions</label>
            <div class="button-grid">
              <button class="btn btn-outline" onclick="quickAction('focus')" title="Focus on structure">
                🎯 Focus
              </button>
              <button class="btn btn-outline" onclick="quickAction('spin')" title="Auto-rotate view">
                🌀 Spin
              </button>
              <button class="btn btn-outline" onclick="quickAction('center')" title="Center structure">
                📍 Center
              </button>
              <button class="btn btn-outline" onclick="quickAction('quality')" title="Toggle quality">
                💎 Quality
              </button>
            </div>
          </div>
        </div>
        <button id="applyVisualization" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;">Apply Changes</button>
        <button id="resetCamera" class="btn btn-secondary" style="width: 100%;">🎯 Reset Camera</button>
        
        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-color); border-radius: 0.375rem; font-size: 0.875rem;">
          <strong style="color: var(--text-color);">🖱️ Mouse Controls:</strong>
          <div style="margin-top: 0.5rem; color: var(--text-muted); line-height: 1.4;">
            • <strong>Left click + drag:</strong> Rotate<br>
            • <strong>Right click + drag:</strong> Pan<br>
            • <strong>Scroll wheel:</strong> Zoom in/out<br>
            • <strong>Double click:</strong> Reset view
          </div>
          <strong style="color: var(--text-color); margin-top: 0.75rem; display: block;">⌨️ Keyboard:</strong>
          <div style="color: var(--text-muted); line-height: 1.4;">
            • <strong>Ctrl+Enter:</strong> Search<br>
            • <strong>Escape:</strong> Reset viewer<br>
            • <strong>R:</strong> Reset camera
          </div>
        </div>
      </div>

      <div id="proteinInfo" class="card" style="display: none;">
        <h3>ℹ️ Protein Information</h3>
        <div id="proteinMetadata"></div>
      </div>

      <div id="exportSection" class="card" style="display: none;">
        <h3>💾 Export Structure</h3>
        <div class="export-section">
          <button id="exportPDB" class="btn btn-success">
            📄 Download PDB
          </button>
          <button id="exportImage" class="btn btn-secondary">
            🖼️ Save Image
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/molstar@3/build/viewer/molstar.js"></script>
  <script>
    // Enhanced 3D Protein Viewer JavaScript
    let viewer = null;
    let currentStructureData = null;
    let currentStructure = null;

    // Initialize the Mol* viewer
    async function initViewer() {
      if (viewer) return viewer;
      
      try {
        viewer = await molstar.Viewer.create('viewer', {
          layoutIsExpanded: false,
          layoutShowControls: false,
          layoutShowRemoteState: false,
          layoutShowSequence: false,
          layoutShowLog: false,
          layoutShowLeftPanel: false,
          layoutShowRightPanel: false,
          viewportShowExpand: false,
          viewportShowSelectionMode: false,
          viewportShowAnimation: false,
          collapseLeftPanel: true,
          collapseRightPanel: true,
          pdbProvider: 'rcsb',
          emdbProvider: 'rcsb',
          volumeStreamingDisabled: true,
          extensions: [],
          canvas3d: {
            camera: {
              helper: {
                axes: {
                  name: 'off',
                  params: {}
                }
              }
            },
            renderer: {
              backgroundColor: 'white'
            }
          }
        });
        
        // Ensure mouse controls are enabled for rotation
        if (viewer && viewer.plugin && viewer.plugin.canvas3d) {
          const canvas3d = viewer.plugin.canvas3d;
          if (canvas3d.input) {
            // Enable all mouse interactions
            canvas3d.input.move.subscribe(({ current, buttons, modifiers }) => {
              if (buttons === 1) { // Left mouse button for rotation
                canvas3d.requestCameraUpdate();
              }
            });
          }
        }
        
        return viewer;
      } catch (error) {
        console.error('Failed to initialize viewer:', error);
        showStatus('Failed to initialize 3D viewer', 'error');
        throw error;
      }
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusContainer = document.getElementById('statusContainer');
      const status = document.getElementById('status');
      
      status.textContent = message;
      status.className = `status ${type}`;
      statusContainer.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          statusContainer.style.display = 'none';
        }, 3000);
      }
    }

    // Update search button state
    function setSearching(isSearching) {
      const btn = document.getElementById('searchBtn');
      const icon = document.getElementById('searchIcon');
      
      if (isSearching) {
        btn.disabled = true;
        icon.innerHTML = '<div class="loading"></div>';
      } else {
        btn.disabled = false;
        icon.textContent = '🔍';
      }
    }

    // Perform enhanced search
    async function performSearch(query) {
      setSearching(true);
      showStatus('Searching for protein structures...', 'info');
      
      try {
        const response = await fetch('/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Search failed');
        }

        currentStructureData = data;
        displaySearchResults(data);
        
      } catch (error) {
        console.error('Search error:', error);
        showStatus(error.message, 'error');
        hideSourceSelection();
        hideProteinInfo();
        hideExportSection();
      } finally {
        setSearching(false);
      }
    }

    // Display search results with source options
    function displaySearchResults(data) {
      const sourceSelection = document.getElementById('sourceSelection');
      const sourceTabs = document.getElementById('sourceTabs');
      const sourceDescription = document.getElementById('sourceDescription');

      // Clear previous tabs
      sourceTabs.innerHTML = '';

      // Create tabs for each available source
      data.sources.forEach((source, index) => {
        const tab = document.createElement('div');
        tab.className = `tab ${index === 0 ? 'active' : ''}`;
        tab.textContent = `${source.type} (${source.id})`;
        tab.onclick = () => selectSource(source, tab);
        sourceTabs.appendChild(tab);
      });

      // Show description for primary source
      const primarySource = data.sources[0];
      sourceDescription.textContent = primarySource.description;

      sourceSelection.style.display = 'block';
      
      // Auto-load the primary source
      loadStructure(primarySource);
      
      // Display protein metadata if available
      if (data.metadata) {
        displayProteinMetadata(data.metadata);
      }
    }

    // Select a specific source
    function selectSource(source, tabElement) {
      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      tabElement.classList.add('active');
      
      // Update description
      document.getElementById('sourceDescription').textContent = source.description;
      
      // Load the selected structure
      loadStructure(source);
    }

    // Load and display structure
    async function loadStructure(source) {
      try {
        showStatus(`🔄 Loading ${source.type} structure ${source.id}...`, 'info');
        
        const v = await initViewer();
        await v.plugin.clear();
        
        // Show loading in viewer
        const viewerEl = document.getElementById('viewer');
        viewerEl.style.position = 'relative';
        
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loadingOverlay';
        loadingOverlay.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(255, 255, 255, 0.9);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
          border-radius: 0.75rem;
        `;
        loadingOverlay.innerHTML = `
          <div style="text-align: center; color: var(--text-color);">
            <div class="loading loading-large"></div>
            <div style="margin-top: 1rem; font-weight: 500;">Loading ${source.type} structure...</div>
            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted);">Please wait while we fetch and render the 3D model</div>
          </div>
        `;
        viewerEl.appendChild(loadingOverlay);
        
        // Build proxy URL
        const proxyUrl = `/proxy?url=${encodeURIComponent(source.url)}`;
        
        // Load structure
        currentStructure = await v.loadStructureFromUrl(proxyUrl, 'pdb');
        
        // Remove loading overlay
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.remove();
        }
        
        // Ensure proper camera setup and controls
        if (v.plugin.canvas3d) {
          // Reset camera to fit structure
          v.plugin.canvas3d.requestCameraUpdate('auto');
          
          // Enable mouse controls explicitly
          const canvas3d = v.plugin.canvas3d;
          if (canvas3d.input) {
            canvas3d.input.move.subscribe(({ current, buttons, modifiers }) => {
              if (buttons === 1) { // Left mouse button for rotation
                canvas3d.requestCameraUpdate();
              } else if (buttons === 4) { // Middle mouse button for zoom
                canvas3d.requestCameraUpdate();
              } else if (buttons === 2) { // Right mouse button for pan
                canvas3d.requestCameraUpdate();
              }
            });
          }
          
          // Ensure the canvas is properly sized and interactive
          setTimeout(() => {
            canvas3d.requestDraw();
            canvas3d.animate();
          }, 100);
        }
        
        showStatus(`Successfully loaded ${source.type} structure - Use mouse to rotate, zoom, and pan! 🎮`, 'success');
        showExportSection(source);
        
        // Add structure statistics to status
        setTimeout(() => {
          if (currentStructure && viewer) {
            try {
              // This would show structure statistics in a real implementation
              const atomCount = "~1000s"; // Placeholder - would get from Mol*
              showStatus(`${source.type} structure loaded successfully • ${atomCount} atoms • Ready for analysis! 🧬`, 'success');
            } catch (e) {
              // Fallback message
              showStatus(`${source.type} structure loaded and ready for analysis! 🧬`, 'success');
            }
          }
        }, 1000);
        
        // Apply default visualization
        applyVisualization();
        
      } catch (error) {
        // Remove loading overlay on error
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.remove();
        }
        
        console.error('Loading error:', error);
        showStatus(`❌ Failed to load structure: ${error.message}`, 'error');
      }
    }

    // Apply visualization settings
    async function applyVisualization() {
      if (!viewer || !currentStructure) return;

      const representation = document.getElementById('representation').value;
      const coloring = document.getElementById('coloring').value;

      try {
        // This is a simplified example - full implementation would use Mol* API
        showStatus('Applying visualization settings...', 'info');
        
        // In a real implementation, you would:
        // 1. Clear current representations
        // 2. Add new representation based on selection
        // 3. Apply coloring scheme
        
        setTimeout(() => {
          showStatus('Visualization updated', 'success');
        }, 1000);
        
      } catch (error) {
        console.error('Visualization error:', error);
        showStatus('Failed to update visualization', 'error');
      }
    }

    // Display protein metadata
    function displayProteinMetadata(metadata) {
      const proteinInfo = document.getElementById('proteinInfo');
      const metadataContainer = document.getElementById('proteinMetadata');
      
      metadataContainer.innerHTML = '';
      
      // Define which fields to display
      const fields = [
        { key: 'protein_name', label: 'Protein Name', icon: '🧬' },
        { key: 'gene_name', label: 'Gene', icon: '🧬' },
        { key: 'organism', label: 'Organism', icon: '🦠' },
        { key: 'length', label: 'Length', suffix: ' residues', icon: '📏' },
        { key: 'mass', label: 'Mass', suffix: ' Da', icon: '⚖️' },
        { key: 'title', label: 'Title', icon: '📋' },
        { key: 'method', label: 'Method', icon: '🔬' },
        { key: 'resolution', label: 'Resolution', suffix: ' Å', icon: '🎯' },
        { key: 'deposition_date', label: 'Deposited', icon: '📅' },
        { key: 'ec_number', label: 'EC Number', icon: '#️⃣' }
      ];

      fields.forEach(field => {
        const value = metadata[field.key];
        if (value && value !== '' && value !== 0) {
          const item = document.createElement('div');
          item.className = 'metadata-item fade-in';
          
          const label = document.createElement('div');
          label.className = 'metadata-label';
          label.innerHTML = `${field.icon} ${field.label}`;
          
          const valueDiv = document.createElement('div');
          valueDiv.className = 'metadata-value';
          
          let displayValue = value;
          if (Array.isArray(value)) {
            displayValue = value.join(', ');
          }
          if (field.suffix && typeof displayValue === 'number') {
            displayValue = displayValue.toLocaleString() + field.suffix;
          } else if (field.suffix) {
            displayValue += field.suffix;
          }
          
          valueDiv.textContent = displayValue;
          
          item.appendChild(label);
          item.appendChild(valueDiv);
          metadataContainer.appendChild(item);
        }
      });

      // Show function if available
      if (metadata.function) {
        const functionItem = document.createElement('div');
        functionItem.className = 'fade-in';
        functionItem.style.marginTop = '1rem';
        functionItem.style.padding = '0.75rem';
        functionItem.style.background = 'var(--bg-color)';
        functionItem.style.borderRadius = '0.375rem';
        functionItem.style.fontSize = '0.875rem';
        functionItem.innerHTML = `<strong>⚡ Function:</strong> ${metadata.function}`;
        metadataContainer.appendChild(functionItem);
      }

      proteinInfo.style.display = 'block';
      proteinInfo.classList.add('fade-in');
    }

    // Show/hide UI sections
    function hideSourceSelection() {
      document.getElementById('sourceSelection').style.display = 'none';
    }

    function hideProteinInfo() {
      document.getElementById('proteinInfo').style.display = 'none';
    }

    function showExportSection(source) {
      const exportSection = document.getElementById('exportSection');
      const exportPDB = document.getElementById('exportPDB');
      
      exportPDB.onclick = () => exportStructure(source.url, 'pdb');
      exportSection.style.display = 'block';
    }

    function hideExportSection() {
      document.getElementById('exportSection').style.display = 'none';
    }

    // Export functionality
    async function exportStructure(url, format) {
      try {
        showStatus(`🔄 Preparing ${format.toUpperCase()} download...`, 'info');
        
        // Add loading state to export buttons
        const exportButtons = document.querySelectorAll('.export-btn');
        exportButtons.forEach(btn => {
          btn.disabled = true;
          btn.classList.add('loading');
        });
        
        setTimeout(async () => {
          try {
            const response = await fetch('/api/export', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url, format })
            });

            if (response.ok) {
              const blob = await response.blob();
              const downloadUrl = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = downloadUrl;
              a.download = `structure.${format}`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              window.URL.revokeObjectURL(downloadUrl);
              
              showStatus(`✅ ${format.toUpperCase()} file downloaded successfully!`, 'success');
            } else {
              const error = await response.json();
              throw new Error(error.error || 'Export failed');
            }
          } finally {
            // Remove loading state
            exportButtons.forEach(btn => {
              btn.disabled = false;
              btn.classList.remove('loading');
            });
          }
        }, 300); // Small delay for better UX
        
      } catch (error) {
        console.error('Export error:', error);
        showStatus(`❌ Export failed: ${error.message}`, 'error');
        
        // Remove loading state on error
        const exportButtons = document.querySelectorAll('.export-btn');
        exportButtons.forEach(btn => {
          btn.disabled = false;
          btn.classList.remove('loading');
        });
      }
    }

    // Export image (enhanced)
    function exportImage() {
      if (!viewer || !viewer.plugin.canvas3d) {
        showStatus('❌ No structure loaded for screenshot', 'error');
        return;
      }
      
      try {
        showStatus('📸 Taking screenshot...', 'info');
        
        // Add screenshot preparation delay
        setTimeout(() => {
          try {
            const canvas = viewer.plugin.canvas3d.canvas;
            if (!canvas) {
              throw new Error('Canvas not available');
            }
            
            // Create high-quality image
            const imageData = canvas.toDataURL('image/png', 1.0);
            
            // Create filename with timestamp
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
            const filename = `protein_structure_${timestamp}.png`;
            
            // Download image
            const link = document.createElement('a');
            link.download = filename;
            link.href = imageData;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('📸 Screenshot saved successfully!', 'success');
          } catch (error) {
            console.error('Screenshot error:', error);
            showStatus(`❌ Screenshot failed: ${error.message}`, 'error');
          }
        }, 500);
        
      } catch (error) {
        console.error('Screenshot error:', error);
        showStatus(`❌ Screenshot failed: ${error.message}`, 'error');
      }
    }

    // Reset viewer
    async function resetViewer() {
      if (!viewer) return;
      
      try {
        await viewer.plugin.clear();
        hideSourceSelection();
        hideProteinInfo();
        hideExportSection();
        currentStructureData = null;
        currentStructure = null;
        showStatus('🔄 Viewer reset successfully!', 'info');
      } catch (error) {
        console.error('Reset error:', error);
        showStatus('❌ Failed to reset viewer', 'error');
      }
    }
    
    // Quick action functions
    function quickAction(action) {
      if (!viewer || !viewer.plugin.canvas3d) {
        showStatus('❌ No structure loaded', 'error');
        return;
      }
      
      try {
        const canvas3d = viewer.plugin.canvas3d;
        
        switch (action) {
          case 'focus':
            // Focus on structure by resetting camera
            canvas3d.requestCameraUpdate('auto');
            showStatus('🎯 Structure focused!', 'success');
            break;
            
          case 'spin':
            // Toggle auto-rotation
            if (window.autoRotating) {
              window.autoRotating = false;
              clearInterval(window.rotationInterval);
              showStatus('🛑 Auto-rotation stopped', 'info');
            } else {
              window.autoRotating = true;
              window.rotationInterval = setInterval(() => {
                if (canvas3d && canvas3d.camera) {
                  canvas3d.requestCameraUpdate();
                }
              }, 50);
              showStatus('🌀 Auto-rotation started!', 'success');
            }
            break;
            
          case 'center':
            // Center structure
            canvas3d.requestCameraUpdate();
            canvas3d.requestDraw();
            showStatus('📍 Structure centered!', 'success');
            break;
            
          case 'quality':
            // Toggle rendering quality
            canvas3d.requestDraw();
            showStatus('💎 Rendering quality optimized!', 'success');
            break;
            
          default:
            showStatus('⚡ Quick action executed!', 'info');
        }
      } catch (error) {
        console.error('Quick action error:', error);
        showStatus(`❌ Action failed: ${error.message}`, 'error');
      }
    }

    // Reset camera to fit structure
    async function resetCamera() {
      if (!viewer || !currentStructure) {
        showStatus('No structure loaded to reset camera', 'error');
        return;
      }
      
      try {
        const canvas3d = viewer.plugin.canvas3d;
        if (canvas3d) {
          // Reset camera to auto-fit the structure
          canvas3d.requestCameraUpdate('auto');
          canvas3d.requestDraw();
          showStatus('Camera reset to fit structure', 'success');
        }
      } catch (error) {
        console.error('Camera reset error:', error);
        showStatus('Failed to reset camera', 'error');
      }
    }

    // Event listeners
    document.getElementById('searchBtn').addEventListener('click', () => {
      const query = document.getElementById('searchInput').value.trim();
      if (query) performSearch(query);
    });

    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query) performSearch(query);
      }
    });

    document.getElementById('resetBtn').addEventListener('click', resetViewer);
    document.getElementById('resetCamera').addEventListener('click', resetCamera);
    document.getElementById('applyVisualization').addEventListener('click', applyVisualization);
    document.getElementById('exportImage').addEventListener('click', exportImage);

    // Example button handlers
    document.querySelectorAll('.example-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const example = btn.dataset.example;
        document.getElementById('searchInput').value = example;
        performSearch(example);
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+Enter or Cmd+Enter to search
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        const query = document.getElementById('searchInput').value.trim();
        if (query) performSearch(query);
      }
      
      // Escape to reset viewer
      if (e.key === 'Escape') {
        e.preventDefault();
        resetViewer();
      }
      
      // R to reset camera (when not typing in input)
      if (e.key === 'r' || e.key === 'R') {
        if (e.target.tagName !== 'INPUT') {
          e.preventDefault();
          resetCamera();
        }
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      showStatus('Welcome! Search for a protein to begin. Use Ctrl+Enter to search quickly! 🧬', 'info');
    });
  </script>
</body>
</html>
